<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>모바일 웹 카메라 테스트</title>
</head>
<body>
  <h1>사진 촬영</h1>
  <video id="camera" autoplay playsinline width="300"></video><br>
  <button onclick="startCamera()" id="startBtn">카메라 시작</button>
  <button onclick="capturePhoto()" id="captureBtn" style="display:none;">촬영</button>
  <button onclick="sendPhoto()" id="sendBtn" style="display:none;" disabled>전송</button><br>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="preview" style="display:none;" width="300">
  <div id="status">카메라 시작 버튼을 눌러주세요</div>

  <script>
    let stream = null;
    let capturedImage = null;

    // 카메라 시작
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment'}
        });
        document.getElementById('camera').srcObject = stream;
        document.getElementById('camera').style.display = 'block';

        // 버튼 상태 변경
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('captureBtn').style.display = 'inline';

        document.getElementById('status').innerHTML = '카메라 준비 완료';
      } catch (e) {
        document.getElementById('status').innerHTML = '카메라 접근 실패: ' + e.message;
      }
    }

    // 사진 촬영
    function capturePhoto() {
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      const preview = document.getElementById('preview');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);

      capturedImage = canvas.toDataURL('image/jpeg');
      preview.src = capturedImage;
      preview.style.display = 'block';

      // 촬영 후 전송 버튼 활성화
      document.getElementById('sendBtn').style.display = 'inline';

      document.getElementById('sendBtn').disabled = false;
      document.getElementById('status').innerHTML = '촬영 완료';
    }

    // 서버 전송
    async function sendPhoto() {
      const formData = new FormData();
      const response = await fetch(capturedImage);
      const blob = await response.blob();
      formData.append('photo', blob, 'photo.jpg');
      formData.append('ID', 'QCP01');
      formData.append('version', '00001');

      try {
        await fetch('https://tuhap.ariapay.jp/', {
          method: 'POST',
          body: formData
        });
      } catch (e) {
        document.getElementById('status').innerHTML = '전송 실패: ' + e.message;
      }
    }
  </script>
</body>
</html>
